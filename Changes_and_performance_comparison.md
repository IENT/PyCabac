# Quick comparison runing the same example for the original and the proposed implementation

Performance has been comppared using [scalene](https://github.com/plasma-umass/scalene) python profiler.

Two demo scripts have been created in the [demo] folder to demonstrate usability.

First, a quick glance of statistics coding and decoding a unitary function of 1e8 bits. Tested on Ubuntu 22.04 with Intel® Core™ i7-9700 CPU @ 3.00GHz × 8.

For the original->
```
Execution time -> 118 s
Max memory usage -> 7.554 GB
```

For the proposed->
```
Execution time -> 2 s
Max memory usage -> 0.77 GB
```

## Changes

The main objective is to move most of the computation to C++ side. For example, removing the for loops from python to avoid data movement and casting Python<-->C++.

The interface now is fully compatible with Numpy, so that when interchanging data between Python and C++, only memory references are passed, avoiding memory copy.

The traceability is disabled, as it resulted in an increasing RAM usage

## Original full trace

```
Memory usage: ▂▂▂▂▃▃▃▃▃▃▃▃▄▄▄▄▅▅▆▆▆▆▆▇▇▇▇ (max: 7.554 GB, growth rate:  86%)                                                                                            
     demo/normal_mode.py: % of time =  99.86% (3m:49.222s) out of 3m:49.464s.                                                                                              
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │demo/normal_mode.py                                                                                                                                                                       
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │import cabac                                                                                                                                                                              
     2 │       │       │       │  98%   │    6M │               │       │import numpy as np                                                                                                                                                                        
     3 │       │       │       │        │       │               │       │import time                                                                                                                                                                               
     4 │       │       │       │        │       │               │       │                                                                                                                                                                                          
     5 │       │       │       │        │       │               │       │# number of bits used for representing the probalities in VTM-cabac                                                                                                                       
     6 │       │       │       │        │       │               │       │PROB_BITS = 15                                                                                                                                                                            
     7 │       │       │       │        │       │               │       │                                                                                                                                                                                          
     8 │       │       │       │        │       │               │       │# context initialization                                                                                                                                                                  
     9 │       │       │       │        │       │               │       │p1_init = 0.5                                                                                                                                                                             
    10 │       │       │       │        │       │               │       │shift_idx = 13                                                                                                                                                                            
    11 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    12 │       │       │       │        │       │               │       │size=100000000                                                                                                                                                                            
    13 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    14 │       │       │       │        │       │               │       │# lets encode a unit step function                                                                                                                                                        
    15 │       │       │       │ 100%   │ 2.98G │▁▂▁  34%       │       │bitsToEncode = [0] * size + [1] * size                                                                                                                                                    
    16 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    17 │       │       │       │        │       │               │       │init_time_normal=time.time()                                                                                                                                                              
    18 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    19 │       │       │       │        │       │               │       │# create an encoder and encode the bits                                                                                                                                                   
    20 │       │       │       │        │       │               │       │enc = cabac.cabacEncoder()                                                                                                                                                                
    21 │       │       │       │        │       │               │       │enc.initCtx([(p1_init, shift_idx)])                                                                                                                                                       
    22 │       │       │       │        │       │               │       │enc.start()                                                                                                                                                                               
    23 │       │       │       │        │       │               │       │for i, bit in enumerate(bitsToEncode):                                                                                                                                                    
    24 │       │       │       │        │       │               │       │    ctx = 0                                                                                                                                                                               
    25 │   49% │       │       │  57%   │    2M │▁▂▂▂▃▃  48%    │       │    enc.encodeBin(bit, ctx)                                                                                                                                                               
    26 │       │       │       │        │       │               │       │enc.encodeBinTrm(1)                                                                                                                                                                       
    27 │       │       │       │        │       │               │       │enc.finish()                                                                                                                                                                              
    28 │       │       │       │        │       │               │       │enc.writeByteAlignment()                                                                                                                                                                  
    29 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    30 │       │       │       │        │       │               │       │# get the bitstream                                                                                                                                                                       
    31 │       │       │       │  85%   │    9M │▁              │       │bs = enc.getBitstream()                                                                                                                                                                   
    32 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    33 │       │       │       │        │       │               │       │# decode in order to sure that we get a enc/dec match                                                                                                                                     
    34 │       │       │       │        │       │               │       │decodedBits = []                                                                                                                                                                          
    35 │       │       │       │        │       │               │       │dec = cabac.cabacDecoder(bs)                                                                                                                                                              
    36 │       │       │       │        │       │               │       │dec.initCtx([(p1_init, shift_idx)])                                                                                                                                                       
    37 │       │       │       │        │       │               │       │dec.start()                                                                                                                                                                               
    38 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    39 │       │       │       │        │       │               │       │for i in range(0, len(bitsToEncode)):                                                                                                                                                     
    40 │       │       │       │        │       │               │       │    ctx = 0                                                                                                                                                                               
    41 │   39% │       │       │        │       │               │       │    decodedBit = dec.decodeBin(ctx)                                                                                                                                                       
    42 │    6% │    2% │       │  69%   │  179M │▂▂▂  18%       │       │    decodedBits.append(decodedBit)                                                                                                                                                        
    43 │       │       │       │        │       │               │       │dec.decodeBinTrm()                                                                                                                                                                        
    44 │       │       │       │        │       │               │       │dec.finish()                                                                                                                                                                              
    45 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    46 │       │       │       │        │       │               │       │# assert that the decoded sequence matches the source symbols                                                                                                                             
    47 │       │       │       │        │       │               │       │assert(bitsToEncode == decodedBits)                                                                                                                                                       
    48 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    49 │       │       │       │        │       │               │       │print(f"Elapsed time in previous mode->{time.time()-init_time_normal} s")                                                                                                                 
    50 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    51 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    52 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    53 │       │       │       │        │       │               │       │                                                                                                                                                                                          
    54 │       │       │       │        │       │               │       │                                                                                                                                                                                          
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                          
Top AVERAGE memory consumption, by line:
(1)    42:    34 MB                                                                                                                                                                                                                                                 
(2)    31:     9 MB                                                                                                                                                                                                                                                 
(3)    25:     1 MB                                                                                                                                                                                                                                                 
Top PEAK memory consumption, by line:
(1)    15:  3052 MB                                                                                                                                                                                                                                                 
(2)    42:   179 MB                                                                                                                                                                                                                                                 
(3)    31:     9 MB                                                                                                                                                                                                                                                 
(4)     2:     6 MB                                                                                                                                                                                                                                                 
(5)    25:     2 MB
```
## Proposed full trace
```
Memory usage: ▁▁▁▁▁▁▁▁▁▁▁▂▃▅▅██▇▅▅▅▇▆▅▅▅▅ (max: 770.961 MB, growth rate:  34%)                                                                                                                
                  demo/numpy_mode.py: % of time =  83.27% (1.801s) out of 2.164s.                                                                                                                       
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                    
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                    
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │demo/numpy_mode.py                                                                                                                                                                                                                  
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │import cabac                                                                                                                                                                                                                        
     2 │       │       │       │  98%   │    6M │               │       │import numpy as np                                                                                                                                                                                                                  
     3 │       │       │       │        │       │               │       │import time                                                                                                                                                                                                                         
     4 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
     5 │       │       │       │        │       │               │       │# number of bits used for representing the probalities in VTM-cabac                                                                                                                                                                 
     6 │       │       │       │        │       │               │       │PROB_BITS = 15                                                                                                                                                                                                                      
     7 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
     8 │       │       │       │        │       │               │       │# context initialization                                                                                                                                                                                                            
     9 │       │       │       │        │       │               │       │p1_init = 0.5                                                                                                                                                                                                                       
    10 │       │       │       │        │       │               │       │shift_idx = 13                                                                                                                                                                                                                      
    11 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    12 │       │       │       │        │       │               │       │size=100000000                                                                                                                                                                                                                      
    13 │       │       │       │        │       │               │       │# lets encode a unit step function                                                                                                                                                                                                  
    14 │       │       │       │        │       │               │       │#bitsToEncode = [0] * size + [1] * size                                                                                                                                                                                             
    15 │       │       │       │        │       │               │       │#bitsToEncode=np.array(bitsToEncode,dtype=np.uint8)                                                                                                                                                                                 
    16 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    17 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    18 │       │    9% │       │        │  381M │▁▁▂  33%       │    90 │bitsToEncode=np.concatenate((np.zeros(size,dtype=np.uint8),np.ones(size,dtype=np.uint8)))                                                                                                                                           
    19 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    20 │       │       │       │        │       │               │       │init_time_numpy=time.time()                                                                                                                                                                                                         
    21 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    22 │       │       │       │        │       │               │       │# create an encoder and encode the bits                                                                                                                                                                                             
    23 │       │       │       │        │       │               │       │enc = cabac.cabacEncoder()                                                                                                                                                                                                          
    24 │       │       │       │        │       │               │       │enc.initCtx([(p1_init, shift_idx)])                                                                                                                                                                                                 
    25 │       │       │       │        │       │               │       │enc.start()                                                                                                                                                                                                                         
    26 │       │   33% │   2%  │        │  383M │▂▃▂▂  33%      │   176 │enc.encodeBinsWrapperNumpy(bitsToEncode)                                                                                                                                                                                            
    27 │       │       │       │        │       │               │       │enc.encodeBinTrm(1)                                                                                                                                                                                                                 
    28 │       │       │       │        │       │               │       │enc.finish()                                                                                                                                                                                                                        
    29 │       │       │       │        │       │               │       │enc.writeByteAlignment()                                                                                                                                                                                                            
    30 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    31 │       │       │       │        │       │               │       │# get the bitstream                                                                                                                                                                                                                 
    32 │       │       │       │        │       │               │       │bs = np.array(enc.getBitstreamWrapperNumpy(),dtype=np.uint8,copy=False)                                                                                                                                                             
    33 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    34 │       │       │       │        │       │               │       │# decode in order to sure that we get a enc/dec match                                                                                                                                                                               
    35 │       │       │       │        │    2M │▁              │       │dec = cabac.cabacDecoder(bs)                                                                                                                                                                                                        
    36 │       │       │       │        │       │               │       │dec.initCtx([(p1_init, shift_idx)])                                                                                                                                                                                                 
    37 │       │       │       │        │       │               │       │dec.start()                                                                                                                                                                                                                         
    38 │       │   34% │   1%  │        │  191M │▁  17%         │       │decodedBits=np.array(dec.decodeBinsWrapperNumpy(len(bitsToEncode)),dtype=np.uint8,copy=False)                                                                                                                                       
    39 │       │       │       │        │       │               │       │dec.finish()                                                                                                                                                                                                                        
    40 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    41 │       │       │       │        │       │               │       │# assert that the decoded sequence matches the source symbols                                                                                                                                                                       
    42 │       │       │       │        │  191M │▁▁  17%        │       │assert((bitsToEncode == decodedBits).all())#np.array_equal(bitsToEncode,decodedBits)                                                                                                                                                
    43 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    44 │       │       │       │        │       │               │       │print(f"Elapsed time in numpy no-copy mode->{time.time()-init_time_numpy} s")                                                                                                                                                       
    45 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    46 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    47 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    48 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
    49 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                    
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                    
Top AVERAGE memory consumption, by line:
(1)    26:   383 MB                                                                                                                                                                                                                                                                                           
(2)    42:   191 MB                                                                                                                                                                                                                                                                                           
(3)    38:   191 MB                                                                                                                                                                                                                                                                                           
(4)    35:     2 MB                                                                                                                                                                                                                                                                                           
Top PEAK memory consumption, by line:
(1)    26:   383 MB                                                                                                                                                                                                                                                                                           
(2)    18:   381 MB                                                                                                                                                                                                                                                                                           
(3)    42:   191 MB                                                                                                                                                                                                                                                                                           
(4)    38:   191 MB                                                                                                                                                                                                                                                                                           
(5)     2:     6 MB
```